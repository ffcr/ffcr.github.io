<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>世界运行</title>
<style>
[draggable=true]{cursor: move;}
canvas{
	image-rendering: pixelated;
}
body{
	background-color: black; /* text-align: center;  margin: 0 auto;*/
}
</style>
</head>

<body>
<script>
	function download(file,str){
		const blob=new Blob([str],{type:'text/plain;charset=utf-8'});const url=URL.createObjectURL(blob);
		const a=document.createElement('a');a.href=url;a.download=file;document.body.appendChild(a);a.click();
		setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},0); 
	}
	function upload(then) {
		const fileInput=document.getElementById('fileInput');const file=fileInput.files[0];if(!file)return;
		const reader=new FileReader();reader.onerror=function(){console.error("读取失败:", reader.error);};
		reader.onload=function(e){then(e.target.result);};reader.readAsText(file);
	}
</script>
<div style="color:white;width: 512px;">
	<div style="display: inline; float: left;">
		运行速度：每秒
		<input type="number" style="width: 8ch;" value="20" id="SPEED"/>
		刻
		<input type="submit" id="PAUSE" value="点击暂停" onclick="this.value=(this.pause=!this.pause)?'已暂停，点击继续':'点击暂停'">
	</div>
	<div style="display: inline; float: right;">
		<input type="button" value="加载世界" onclick="document.getElementById('fileInput').click();"/>
		<input type="file" id="fileInput" style="display: none; width: 0;" onchange="upload(str=>{WORLD=(0,eval)(str)});this.value=''">
		<input type="submit" value="保存世界" onclick="download(new Date().toLocaleString('sv').replaceAll(/[:\-]/g,'').replaceAll(' ','-')+'.save.js',uneval(WORLD))">
	</div>
</div>
<canvas id="canvas" width=512 height=512 style="width:512px;height:512px"></canvas>

<div style="color:white">
	红：指令节点；绿：数据节点；白：空白；灰：游离数据；蓝：<b style="color: blue;">深层</b>嵌套世界
	<br>
    <form>
		点击一格：
        <input type="radio" name="clickObjectOption" value="edit" checked>查看与编辑物体&nbsp;
        <input type="radio" name="clickObjectOption" value="gen">大量生成该物体&nbsp;
        <input type="radio" name="clickObjectOption" value="jumpIn">进入该世界&nbsp;
        <input type="button" style="color:aqua;background-color: black;" value="跳出当前世界" onclick="jumpOutWorld()"/>
    </form>
	<input type="submit" value="大量生成" style="color: green;" onclick="openTextEditor('大量生成物体',globalThis.PROGRAM_PROTOTYPE??EXAMPLES.REPLICATING,text=>{globalThis.PROGRAM_PROTOTYPE=text;randGenWorld((x,y)=>(0,eval)(text),1/16)},event.pageX,Math.max(0,event.pageY-200));">
	<input type="submit" value="样例物体：自我复制流程图" style="color: green;" onclick="showExample('REPLICATING');">
	<br>
	渲染精度：每格
	<input type="number" style="width: 8ch;" step="1" value="16" onchange="this.value=RENDER_CELL_SIZE=Math.max(1,Math.min((2048**2/(d=>d.width*d.height)(globalThis?.WORLD??{width:32,height:32}))**.5|0,this.value|0))" />
	像素
	<br>
	随机修改率：
	<input type="number" style="width: 12ch;" step="0.001" value="0.005" onchange="this.value=RANDOM_CHANGE_RATE=Math.max(0,Math.min(1,this.value||0))" />
	，随机注入能量：
	<input type="number" style="width: 12ch;" step="100" value="500" onchange="this.value=RANDOM_ENERGY_GAIN=Math.max(0,Math.min(Infinity,this.value||0))" />
</div>
<script>
//直接将输入框的初始值视作“第一个输入”，走一遍onchange流程，进行变量的初始化，避免了为了初始化重复写变量名与值的代码。
for(let input of document.querySelectorAll('input'))input.onchange?.();

globalThis.randGenWorld=function(gen,rate){let w=WORLD.width,h=WORLD.height;for(let y=0;y<h;y++)for(let x=0;x<w;x++)if(Math.random()<rate)WORLD.swap(new Pos(x,y),gen(x,y));}
globalThis.showExample=function(name){openTextEditor('样例物体',EXAMPLES[name],text=>{},event.pageX,Math.max(0,event.pageY-200))}
globalThis.EXAMPLES={
REPLICATING:`
//自我复制流程图：多次放置降低因随机因素灭绝的概率
//有可能随机进化出跳出世界的指令，当自己所在的世界并非最外层世界时就会跳出
let width=5,height=5;
let sample=function(a){return a[a.length*Math.random()>>>0]}
let shuffle=function(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
let allocPos=function*(){let all=Array.from(Array(height),(_,y)=>Array.from(Array(width),(_,x)=>new Pos(x,y))).flat();for(let p of shuffle(all))yield p}();

let datas={zero:new DataNode(I32,0),x:new DataNode(I32,2),y:new DataNode(I32,1),t:new DataNode(I32,0),threshold:new DataNode(I32,10000),env:new DataNode(Any,undefined)};
for(let v in datas)datas[v]={pos:allocPos.next().value,node:datas[v]};

let instNodes;with(datas){instNodes=[
    [ENERGY,t],[GTE,t,t,threshold],[IF,t],
    [MOVE,x,y],[SELF_COPY,env],[SWAP,env],[RECYCLE,env],
    [ASSIGN,x,y],[ASSIGN,y,t],[ASSIGN,t,x],[SUB,x,zero,x],[MOVE,x,y],
];}

let insts=instNodes.map(([inst,...argPoss],i)=>{let pos=allocPos.next().value;return {node:new InstNode(inst,(inst===IF?[Pos.ZERO,Pos.ZERO]:[Pos.ZERO]),argPoss.map(v=>v.pos.sub(pos)),i===0),pos};});
for(let i=1;i<insts.length;i++)insts[i-1].node.branchPoss[0]=insts[i].pos.sub(insts[i-1].pos);

new Env(width,height,100000).setMultiple([...Object.values(datas),...insts].map(({pos,node})=>[pos.x,pos.y,node]))
`
}
</script>

<script>
	function openTextEditor(title,currentText,onSave,x0=0,y0=0) {
		const editor=document.createElement('div');
		editor.innerHTML=`
			<div>${title}</div>
			<textarea style="display:block;width:300px;height:150px;margin-bottom:8px;font-family:monospace;">${currentText}</textarea>
			<button style="float: right;" class="confirm">确认</button>
			<button style="float: right;" class="cancel">取消</button>
		`;
		editor.style.cssText=`background-color:white;position:absolute;z-index:${openTextEditor.zIndex++};touch-action:none;`;
		editor.style.left='0px';editor.style.top='0px';
		/**@template T @param {(any,any)=>T} f*/
		function vecFn(f,a,b){return Array.from(a,(_,i)=>f(a[i],b[i]))}
		
		let ex,ey,tr=(x,y)=>{ex=x;ey=y;editor.style.transform =`translate(${x}px,${y}px)`};tr(x0,y0);editor.draggable=true;
		let dx,dy,xyOf=e=>e instanceof DragEvent?[e.pageX,e.pageY]:e instanceof TouchEvent?Array.from(e.touches,t=>[t.pageX,t.pageY]).at(-1):'throw unknown event type'();
		/**@template T @param {T} f*/let assign=(o,k,f)=>o[k]=f;let fns={};let sub=(x,y)=>x-y;
		editor.addEventListener('dragstart',assign(fns,'dragstart',e=>{[dx,dy]=vecFn(sub,xyOf(e),[ex,ey]);}));
		editor.addEventListener('drag',assign(fns,'drag',e=>{tr(...vecFn(sub,xyOf(e),[dx,dy]))}));
		for(let [i,f] of [['dragend',fns.drag],['touchstart',fns.dragstart],['touchmove',fns.drag]])editor.addEventListener(i,f,{passive:true});
		
		editor.querySelector('.confirm').onclick=() => {
			onSave(editor.querySelector('textarea').value);
			document.body.removeChild(editor);
		};
		editor.querySelector('.cancel').onclick=() => document.body.removeChild(editor);

		document.body.appendChild(editor);
	}
	openTextEditor.zIndex=1000;
</script>


<script type="module">
	import {tickLogic,renderLogic} from "./flowchartWorld.js";
	let toTick=0,lastTime=new Date();
	function runTickLoop(){
		if(document.getElementById('PAUSE').pause){lastTime=new Date();return;}
		toTick+=+document.getElementById('SPEED').value*(new Date()-lastTime)/1000;lastTime=new Date();
		let deadline=+new Date()+1000/4;//1000刻的耗时可能太长，为了避免一直卡住，最多只允许卡1/4秒
		while(toTick>=1){
			try{tickLogic();}catch(e){let pause=document.getElementById('PAUSE');pause.pause=true;pause.value='出错，已自动暂停';throw e;}
			toTick--;if(new Date()>deadline){toTick=0;break;}
		}
	}
	setInterval(runTickLoop,1000/60);

	const RAF=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback, 1000 / 60);}).bind(window);
	(function runRenderLoop(){renderLogic();window.requestAnimationFrame(runRenderLoop);})();

	let canvas=document.getElementById('canvas');
	canvas.onmouseup=canvas.ontouchend=function(ev){
		ev=ev instanceof TouchEvent?[...ev.touches].at(-1):ev;if(ev==null)return;
		let rect=canvas.getBoundingClientRect();
		let [x,y]=[(ev.clientX-rect.left)/canvas.offsetWidth*WORLD.width|0,(ev.clientY-rect.top)/canvas.offsetHeight*WORLD.height|0];
		if((ev.button??0)===0)switch(document.querySelector('input[name="clickObjectOption"]:checked').value){
            case "edit":setTimeout(()=>openTextEditor('修改('+x+','+y+')处物体',uneval(WORLD.get(new Pos(x,y))),text=>{WORLD.swap(new Pos(x,y),(0,eval)(text))},ev.pageX,ev.pageY),0);break
            case "gen":let s=uneval(WORLD.get(new Pos(x,y)));randGenWorld((x,y)=>(0,eval)(s),1/16);break
            case "jumpIn":jumpInWorld(x,y);break
        }
	}
	canvas.oncontextmenu=ev=>false
</script>

</body>
</html>