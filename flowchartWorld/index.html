<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>世界运行</title>
<style>
[draggable=true]{
	cursor: move;
}
canvas{
	image-rendering: pixelated;
}
body{
	background-color: black; /* text-align: center;  margin: 0 auto;*/
}
</style>
</head>

<body>
<script>
	function download(file,str){
		const blob = new Blob([str], { type: 'text/plain;charset=utf-8' }); 
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href=url;a.download=file;
		document.body.appendChild(a);a.click();
		setTimeout(() => {document.body.removeChild(a);URL.revokeObjectURL(url);}, 0); 
	}
	function upload(then) {
		const fileInput = document.getElementById('fileInput');
		
		const file = fileInput.files[0];if(!file)return;
		const reader = new FileReader();
		reader.onload = function (e) {then(e.target.result);};
		reader.onerror = function () {console.error(" 读取失败:", reader.error);};
		reader.readAsText(file);
	}
</script>
<div style="color:white;width: min-content;">
	<div style="display: inline; float: left;">
		运行速度：每秒
		<input type="number" style="width: 8ch;" value="20" id="SPEED"/>
		刻
		<input type="submit" id="PAUSE" value="点击暂停" onclick="this.value=(this.pause=!this.pause)?'已暂停，点击继续':'点击暂停'">
	</div>
	<div style="display: inline; float: right;">
		<input type="button" value="加载世界" id="fakeFileInput" onclick="document.getElementById('fileInput').click();"/>
		<input type="file" id="fileInput" style="display: none; width: 0;" onchange="upload(str=>{WORLD=(0,eval)(str)});this.value=''">
		<input type="submit" id="SAVE" value="保存世界" onclick="download(new Date().toLocaleString('sv').replaceAll(/[:\-]/g,'').replaceAll(' ','-')+'.save.js',uneval(WORLD))">
	</div>
	<canvas id="canvas" width=512 height=512 style="width:512px;height:512px"></canvas>
</div>

<div style="color:white">
	点击一格：<input type="submit" id="buttonForEdit" value="左键⟳">查看与编辑程序，<input type="submit" id="buttonForGen" value="右键⟳">以此为原型随机生成相似图案
	<br>
	<input type="submit" value="随机生成" style="color: green;" onclick="openTextEditor('请粘贴程序原型（留空则完全随机）',globalThis.PROGRAM_PROTOTYPE??'',text=>{globalThis.PROGRAM_PROTOTYPE=text;let tokens=text.trim()===''?[]:(0,eval)(text).source;randGenWorld(tokens,Math.max(tokens.length,10))},event.pageX,event.pageY*0.5);">
	<input type="submit" value="程序样例：康威生命游戏" style="color: green;" onclick="showExample('GOL');">
	<br>
	每
	<input type="number" value="20" id="AUTO_SEARCH_DELAY"/>
	刻
	<input type="submit" id="AUTO_SEARCH" value="自动筛选特征特殊图案并据此随机生成图案" onclick="this.value=(this.pause=!this.pause)?'自动生成图案已禁用':'自动筛选特征特殊图案并据此随机生成图案'">

</div>
<script>
globalThis.showExample=function(name){openTextEditor('样例程序',EXAMPLES[name],text=>{},event.pageX,event.pageY*0.6)}
globalThis.EXAMPLES={
	GOL:'ImgChunk.fromCode("== 3 | round G 0 0 "+Array.from([-1,0,1],y=>Array.from([-1,0,1],x=>x===0&&y===0?"":"+ round G "+x+" "+y+" ")).flat().join("")+"* 0 H= / 1 3")'
}
globalThis.BUTTON_FOR_EDIT=0;{let a=document.getElementById('buttonForEdit'),b=document.getElementById('buttonForGen');a.onclick=b.onclick=e=>{[a.value,b.value]=[b.value,a.value];BUTTON_FOR_EDIT^=1;}}
</script>

<script>
	function openTextEditor(title,currentText,onSave,x0=0,y0=0) {
		const editor = document.createElement('div');
		editor.innerHTML=`
			<div>${title}</div>
			<textarea style="display:block;width:300px;height:150px;margin-bottom:8px">${currentText}</textarea>
			<button style="float: right;" class="confirm">确认</button>
			<button style="float: right;" class="cancel">取消</button>
		`;
		editor.style.cssText=`background-color:white;position:absolute;z-index:${openTextEditor.zIndex++};touch-action:none;`;
		editor.style.left='0px';editor.style.top='0px';
		let ex,ey,tr=(x,y)=>{ex=x;ey=y;editor.style.transform =`translate(${x}px,${y}px)`};tr(x0,y0);
		let dx,dy,xOf=e=>e.pageX||[...e.touches].at(-1).pageX,yOf=e=>e.pageY||[...e.touches].at(-1).pageY;editor.draggable=true;
		/**@template T @param {T} f*/let assign=(o,k,f)=>o[k]=f;let fns={};
		editor.addEventListener('dragstart',assign(fns,'dragstart',e=>{e.touches&&e.preventDefault;dx=xOf(e)-ex;dy=yOf(e)-ey;}));
		editor.addEventListener('drag',assign(fns,'drag',e=>{e.touches&&e.preventDefault;tr(xOf(e)-dx,yOf(e)-dy);}));
		for(let [i,f] of [['dragend',fns.drag],['touchstart',fns.dragstart],['touchmove',fns.drag]])editor.addEventListener(i,f,{passive:true});
		
		editor.querySelector('.confirm').onclick=() => {
			onSave(editor.querySelector('textarea').value);
			document.body.removeChild(editor);
		};
		editor.querySelector('.cancel').onclick=() => document.body.removeChild(editor);

		document.body.appendChild(editor);
	}
	openTextEditor.zIndex=1000;
</script>


<script type="module">
	import {tickLogic,renderLogic} from "./flowchartWorld.js";
	let toTick=0,lastTime=new Date();
	function runTickLoop(){
		if(document.getElementById('PAUSE').pause){lastTime=new Date();return;}
		toTick+=+document.getElementById('SPEED').value*(new Date()-lastTime)/1000;lastTime=new Date();
		let deadline=+new Date()+1000/4;//1000刻的耗时可能太长，为了避免一直卡住，最多只允许卡1/4秒
		while(toTick>=1){
			try{tickLogic();}catch(e){let pause=document.getElementById('PAUSE');pause.pause=true;pause.value='出错，已自动暂停';throw e;}
			toTick--;if(new Date()>deadline){toTick=0;break;}
		}
	}
	setInterval(runTickLoop,1000/60);

	const RAF=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback, 1000 / 60);}).bind(window);
	(function runRenderLoop(){
		renderLogic();
		window.requestAnimationFrame(runRenderLoop);
	})();

	


	let canvas=document.getElementById('canvas');
	canvas.onmouseup=canvas.ontouchend=function(ev){
		ev=ev instanceof TouchEvent?[...ev.touches].at(-1):ev;if(ev==null)return;
		let rect=canvas.getBoundingClientRect();
		let [x,y]=[(ev.clientX-rect.left)/canvas.offsetWidth*WORLD.data[0].length|0,(ev.clientY-rect.top)/canvas.offsetHeight*WORLD.data.length|0];
		if(((ev.button??0)===0)===(BUTTON_FOR_EDIT===0))setTimeout(()=>openTextEditor('修改('+x+','+y+')处程序',uneval(WORLD.data[y][x]),text=>{WORLD.data[y][x]=(0,eval)(text)},ev.pageX,ev.pageY),0);
		else {randGenWorld(WORLD.data[y][x].source,WORLD.data[y][x].source.length);}
	}
	canvas.oncontextmenu=ev=>false
</script>

</body>
</html>