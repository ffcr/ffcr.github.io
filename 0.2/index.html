<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>世界运行</title>
<style>
canvas {
  image-rendering: pixelated;
}
</style>

<script type="text/javascript">
let initFunctions=[],tickFunctions=[];
</script>

<script src="env.js"></script>
<script src="0.2.js"></script>
<script src="render.js"></script>


<script type="text/javascript">
let select;
function start(){
	canvas.onmousedown=function(ev){
		console.log(select=env.getBlock(ev.offsetX*env.lenX/canvas.offsetWidth,ev.offsetY*env.lenY/canvas.offsetHeight),select.E);
	}
	
	for(let f of initFunctions)f();
	tick();
}

function shuffle(arr) {
	let m = arr.length, i;
	while (m) {
		i = (Math.random() * m--) >>> 0;
		[arr[m], arr[i]] = [arr[i], arr[m]]
	}
	return arr;
}

let ticking=true;
function tick(){
	let time0=new Date().getTime();
	let speed=SPEED.value;
	if(!ticking){
		let wait=1000/60;
		setTimeout(tick,wait);
		return;
	}

	let cycle=Math.max(1,Math.round(speed/60));
	for(let c=0;c<cycle;c++){
		let upd__=shuffle(upd);upd=[];
		
		for(let p of upd__){
			let e=p.E;
			if(e instanceof Object&&typeof e.tick==="function")e.tick(p);
		}

		for(let f of tickFunctions)f();
	}
	let wait=1000/speed*cycle-(new Date().getTime()-time0);
	setTimeout(tick,wait);
}
</script>
</head>

<body style="background-color: black;" onload="start()">

<canvas id="canvas" width=512 height=512 style="width:512px;height:512px"></canvas>
<div style="color:white">
运行速度：每秒
<input type="decimal" value="100" id="SPEED" autocomplete="on"/>
刻
<input type="submit" id="PAUSE" value="暂停" onclick="PAUSE.value=(ticking=!ticking)?'暂停':'继续'">
</div>
</body>
</html>