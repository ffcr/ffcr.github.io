<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>世界运行</title>
<style>
canvas {
  image-rendering: pixelated;
}
</style>
</head>

<body style="background-color: black;">

<canvas id="canvas" width=512 height=512 style="width:512px;height:512px"></canvas>
<div style="color:white">
点击图案：左键查看与编辑程序，右键以此为原型随机生成程序相似的图案
<br>
运行速度：每秒
<input type="number" value="20" id="SPEED"  onchange="this.value=Math.max(1,Math.min(this.value,1000))"/>
刻
<input type="submit" id="PAUSE" value="点击暂停" onclick="this.value=(this.pause=!this.pause)?'已暂停，点击继续':'点击暂停'">
<br>
</div>
<script>
	function download(file,str){
		const blob = new Blob([str], { type: 'text/plain;charset=utf-8' }); 
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href=url;a.download=file;
		document.body.appendChild(a);a.click();
		setTimeout(() => {document.body.removeChild(a);URL.revokeObjectURL(url);}, 0); 
	}
	function upload(then) {
		const fileInput = document.getElementById('fileInput');
		
		const file = fileInput.files[0];if(!file)return;
		const reader = new FileReader();
		reader.onload = function (e) {then(e.target.result);};
		reader.onerror = function () {console.error(" 读取失败:", reader.error);};
		reader.readAsText(file);
	}
</script>
<div>
	<input type="submit" id="SAVE" value="保存世界" onclick="download(new Date().toLocaleString('sv').replaceAll(/[:\-]/g,'').replaceAll(' ','-')+'.save.js',uneval(WORLD))">
	<input type="button" value="加载世界" id="fakeFileInput" onclick="document.getElementById('fileInput').click();"/>
	<input type="file" id="fileInput" style="display: none; width: 0;" onchange="upload(str=>{WORLD=(0,eval)(str)});this.value=''">
</div>
<div style="color:white">
	<input type="submit" value="随机生成" style="color: green;" onclick="openTextEditor('请粘贴程序原型（留空则完全随机）',globalThis.PROGRAM_PROTOTYPE??'',text=>{globalThis.PROGRAM_PROTOTYPE=text;let tokens=(0,eval)(text).source;randGenWorld(text.trim()===''?[]:tokens,tokens.length)},event.clientX,event.clientY*0.5);">
	<input type="submit" value="程序样例：康威生命游戏" style="color: green;" onclick="showExample('GOL');">
	<br>
	每
	<input type="number" value="1" id="AUTO_SEARCH_DELAY"  onchange="this.value=Math.max(1,Math.min(this.value,1000))"/>
	秒自动筛选特征特殊的图案并据此随机生成图案
	<input type="submit" id="AUTO_SEARCH" value="自动生成已启用" onclick="this.value=(this.pause=!this.pause)?'已暂停自动生成':'自动生成已启用'">

</div>
<script>
globalThis.showExample=function(name){openTextEditor('样例程序',EXAMPLES[name],text=>{},event.clientX,event.clientY*0.6)}
globalThis.EXAMPLES={
	GOL:'ImgChunk.fromCode("== 3 | round G 0 0 "+Array.from([-1,0,1],y=>Array.from([-1,0,1],x=>x===0&&y===0?"":"+ round G "+x+" "+y+" ")).flat().join("")+"* 0 H= / 1 3")'
}

function autoSearch(){
	let t0=autoSearch.time??=new Date(),t1=new Date();if(t1-t0>1000*document.getElementById("AUTO_SEARCH_DELAY").value){
		autoSearch.time=t1;if(!document.getElementById("AUTO_SEARCH").pause)searchMostSpecial();
	}
}
setInterval(autoSearch,100);
</script>

<script>
	document.addEventListener('dragover',  (e) => {
		e.preventDefault();  // 覆盖浏览器默认阻止行为
	});
	function openTextEditor(title,currentText, onSave,x=0,y=0) {
		const editor = document.createElement('div');
		editor.innerHTML = `
			<div>${title}</div>
			<textarea style="display:block;width:300px;height:150px;margin-bottom:8px">${currentText}</textarea>
			<button style="float: right;" class="confirm">确认</button>
			<button style="float: right;" class="cancel">取消</button>
		`;
		editor.style.cssText = `background-color:white;position:absolute;z-index:${openTextEditor.zIndex++}`;
		editor.style.left  = x  + 'px';
		editor.style.top  = y  + 'px';
		editor.draggable=true;
		let dx,dy;
		editor.addEventListener('dragstart',  (e) => {
			const rect = editor.getBoundingClientRect();
			dx = e.clientX-rect.left;
			dy = e.clientY-rect.top;
		});
		editor.addEventListener('dragend',  (e) => {
			e.preventDefault(); 
			editor.style.left  = e.clientX-dx  + 'px';
			editor.style.top  = e.clientY-dy  + 'px';
		});

		editor.querySelector('.confirm').onclick = () => {
			onSave(editor.querySelector('textarea').value);
			document.body.removeChild(editor);
		};
		editor.querySelector('.cancel').onclick = () => document.body.removeChild(editor);

		document.body.appendChild(editor);
	}
	openTextEditor.zIndex=1000;
</script>


<script type="module">
	import {tickLogic,renderLogic} from "./imageWorld.js";
	let toTick=0,lastTime=new Date();
	function runTickLoop(){
		if(document.getElementById('PAUSE').pause){lastTime=new Date();return;}
		toTick+=+document.getElementById('SPEED').value*(new Date()-lastTime)/1000;lastTime=new Date();
		let deadline=+new Date()+1000/4;//1000刻的耗时可能太长，为了避免一直卡住，最多只允许卡1/4秒
		while(toTick>=1){
			tickLogic();toTick--;
			if(new Date()>deadline){toTick=0;break;}
		}
	}
	setInterval(runTickLoop,1000/60);

	const RAF=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback, 1000 / 60);}).bind(window);
	(function runRenderLoop(){
		renderLogic();
		window.requestAnimationFrame(runRenderLoop);
	})();

	


	let canvas=document.getElementById('canvas');
	canvas.onmouseup=function(ev){
		const width=WORLD[0].length,height=WORLD.length;
		let x=ev.offsetX*width/canvas.offsetWidth|0,y=ev.offsetY*height/canvas.offsetHeight|0,E=uneval(WORLD[y][x]);
		if(ev.button===0)openTextEditor('修改('+x+','+y+')处程序',E,text=>{WORLD[y][x]=(0,eval)(text)},ev.clientX,ev.clientY);
		else {randGenWorld(WORLD[y][x].source,WORLD[y][x].source.length);}
	}
	canvas.oncontextmenu=ev=>false
</script>

</body>
</html>